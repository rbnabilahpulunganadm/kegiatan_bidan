<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Kegiatan Bidan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Yuji+Syuku&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Yuji Syuku', serif;
            background-image: url('https://i.pinimg.com/originals/b7/2c/6a/b72c6a470123e7f42b85e1a2c3a51f89.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .main-container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .title {
            font-family: 'Mochiy Pop One', sans-serif;
            color: #4a4a4a;
        }
        .btn-primary {
            background-color: #ff9ab4; /* Sakura Pink */
            color: white;
            font-family: 'Mochiy Pop One', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #ff7da1;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .input-field {
            border-color: #ffc2d1;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #ff9ab4;
            box-shadow: 0 0 0 3px rgba(255, 154, 180, 0.5);
            outline: none;
        }
        .floating-emoji {
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .tab-button {
            background-color: #f0f0f0;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px 5px 0 0;
        }
        .tab-button.active {
            background-color: #ff9ab4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #ff9ab4;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .optional-field {
            display: none;
        }
        /* Warna berbeda untuk setiap bidan */
        .bidan-linda { background-color: #e3f2fd !important; }
        .bidan-riska { background-color: #f3e5f5 !important; }
        .bidan-aisyah { background-color: #e8f5e8 !important; }
        .bidan-desva { background-color: #fff3e0 !important; }
        .bidan-sarina { background-color: #fce4ec !important; }
        .bidan-other { background-color: #f5f5f5 !important; }
        
        /* Style untuk tabel cetak */
        .print-table {
            border-collapse: collapse;
            width: 100%;
            font-family: 'Arial', sans-serif;
        }
        .print-table th {
            background-color: #ff9ab4;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .print-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .print-header {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Mochiy Pop One', sans-serif;
            color: #4a4a4a;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Elemen audio tersembunyi -->
    <audio id="backgroundAudio" loop autoplay>
        <source src="lagu.mp3" type="audio/mpeg">
        Browser Anda tidak mendukung elemen audio.
    </audio>
    
    <div id="welcome-screen" class="main-container p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
        <p class="text-gray-600 mb-6">Selamat datang di Nabilah Pulungan</p>
        <div class="text-7xl mb-4 floating-emoji">üå∏</div>
        <h1 class="title text-2xl mb-2">„Åì„Çì„Å´„Å°„ÅØ!</h1>
        <p class="text-gray-600 mb-6">Siapa nama kamu?</p>
        <input type="text" id="name-input" class="input-field w-full p-3 rounded-lg border-2 text-center" placeholder="Ketik nama di sini...">
        <button id="start-button" class="btn-primary w-full py-3 mt-4 rounded-lg">Mulai</button>
    </div>

    <div id="main-app" class="main-container p-8 rounded-2xl shadow-xl max-w-6xl w-full hidden">
        <div class="flex mb-4">
            <button class="tab-button active" data-tab="form-tab">Form Input</button>
            <button class="tab-button" data-tab="admin-tab">Admin</button>
            <button class="tab-button" data-tab="stats-tab">Statistik</button>
        </div>

        <!-- Tab Form Input -->
        <div id="form-tab" class="tab-content active">
            <h1 id="form-title" class="title text-xl mb-6 text-center"></h1>
            <form id="activity-form">
                <div class="mb-4">
                    <label for="activity-type" class="block text-gray-700 mb-2">Pilih Jenis Kegiatan:</label>
                    <select id="activity-type" class="input-field w-full p-3 rounded-lg border-2 bg-white">
                        <option value="Mendampingi Partus">Mendampingi Partus</option>
                        <option value="Mendampingi ANC/Senam">Mendampingi ANC/Senam</option>
                        <option value="Home Care">Home Care</option>
                        <option value="Lembur">Lembur</option>
                        <option value="Dapat Pasien Mom Spa">Dapat Pasien Mom Spa</option>
                        <option value="Dapat Pasien Ladies Spa">Dapat Pasien Ladies Spa</option>
                        <option value="Dapat Pasien Baby Spa">Dapat Pasien Baby Spa</option>
                        <option value="Dapat Pasien Kids Spa">Dapat Pasien Kids Spa</option>
                        <option value="Dapat Pasien Umum">Dapat Pasien Umum</option>
                    </select>
                </div>
                
                <!-- Field Lokasi Home Care (Opsional) -->
                <div id="homecare-location-field" class="optional-field mb-4">
                    <label for="homecare-location" class="block text-gray-700 mb-2">Lokasi Home Care (Opsional):</label>
                    <input type="text" id="homecare-location" class="input-field w-full p-3 rounded-lg border-2" placeholder="Contoh: Rumah Pasien, Alamat lengkap...">
                </div>
                
                <div class="mb-4">
                    <label for="patient-name" class="block text-gray-700 mb-2">Nama Pasien:</label>
                    <input type="text" id="patient-name" class="input-field w-full p-3 rounded-lg border-2" placeholder="Nama lengkap pasien...">
                </div>
                
                <!-- Field Keterangan Tambahan (Opsional untuk semua jenis) -->
                <div class="mb-4">
                    <label for="additional-notes" class="block text-gray-700 mb-2">Keterangan Tambahan (Opsional):</label>
                    <textarea id="additional-notes" class="input-field w-full p-3 rounded-lg border-2" rows="3" placeholder="Tambahkan catatan khusus jika diperlukan..."></textarea>
                </div>
                
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="activity-date" class="block text-gray-700 mb-2">Tanggal Kegiatan:</label>
                        <input type="date" id="activity-date" class="input-field w-full p-3 rounded-lg border-2">
                    </div>
                    <div>
                        <label for="activity-time" class="block text-gray-700 mb-2">Waktu Kegiatan:</label>
                        <input type="time" id="activity-time" class="input-field w-full p-3 rounded-lg border-2">
                    </div>
                    <div>
                        <label for="activity-day" class="block text-gray-700 mb-2">Hari Kegiatan:</label>
                        <input type="text" id="activity-day" class="input-field w-full p-3 rounded-lg border-2" readonly>
                    </div>
                </div>
                <button type="submit" id="submit-button" class="btn-primary w-full py-3 rounded-lg">
                    Kirim Laporan
                </button>
            </form>
            <div id="loading-spinner" class="hidden text-center mt-4">
                <p>Mengirim data... üç•</p>
            </div>
            <div id="response-message" class="text-center mt-4 font-bold"></div>
        </div>

        <!-- Tab Admin -->
        <div id="admin-tab" class="tab-content">
            <h2 class="title text-xl mb-4 text-center">Panel Admin</h2>
            <div id="admin-login" class="mb-4">
                <label for="admin-password" class="block text-gray-700 mb-2">Masukkan Sandi Admin:</label>
                <input type="password" id="admin-password" class="input-field w-full p-3 rounded-lg border-2" placeholder="Sandi admin...">
                <button id="login-button" class="btn-primary w-full py-3 mt-4 rounded-lg">Login</button>
            </div>
            <div id="admin-content" class="hidden">
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="refresh-data" class="btn-primary py-2 px-4 rounded-lg">Refresh Data</button>
                    <button id="print-pdf" class="btn-primary py-2 px-4 rounded-lg bg-green-500 hover:bg-green-600">Cetak PDF</button>
                    <button id="export-excel" class="btn-primary py-2 px-4 rounded-lg bg-blue-500 hover:bg-blue-600">Export Excel</button>
                    <button id="print-table" class="btn-primary py-2 px-4 rounded-lg bg-purple-500 hover:bg-purple-600">Print Tabel</button>
                </div>
                
                <!-- Filter Data -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-bidan" class="block text-gray-700 mb-2">Filter Bidan:</label>
                        <select id="filter-bidan" class="input-field w-full p-2 rounded-lg border-2">
                            <option value="all">Semua Bidan</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-kegiatan" class="block text-gray-700 mb-2">Filter Kegiatan:</label>
                        <select id="filter-kegiatan" class="input-field w-full p-2 rounded-lg border-2">
                            <option value="all">Semua Kegiatan</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-tanggal" class="block text-gray-700 mb-2">Filter Tanggal:</label>
                        <input type="date" id="filter-tanggal" class="input-field w-full p-2 rounded-lg border-2">
                    </div>
                </div>
                
                <h3 class="text-lg font-bold mb-2">Data Kegiatan Bidan</h3>
                <div class="overflow-x-auto">
                    <table class="data-table" id="admin-table">
                        <thead>
                            <tr>
                                <th>Hari</th>
                                <th>Tanggal</th>
                                <th>Jam</th>
                                <th>Nama Bidan</th>
                                <th>Jenis Kegiatan</th>
                                <th>Nama Pasien</th>
                                <th>Lokasi Home Care</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Tabel untuk cetakan -->
                <div id="print-area" class="hidden">
                    <div class="print-header">
                        <h1 class="text-2xl font-bold">LAPORAN KEGIATAN BIDAN</h1>
                        <p class="text-lg">Klinik Nabilah Pulungan</p>
                        <p id="print-period" class="text-md"></p>
                    </div>
                    <table class="print-table" id="print-table-content">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Hari</th>
                                <th>Tanggal</th>
                                <th>Jam</th>
                                <th>Nama Bidan</th>
                                <th>Jenis Kegiatan</th>
                                <th>Nama Pasien</th>
                                <th>Lokasi Home Care</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="print-table-body">
                            <!-- Data cetakan akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Statistik -->
        <div id="stats-tab" class="tab-content">
            <h2 class="title text-xl mb-4 text-center">Statistik Kegiatan Bidan</h2>
            <div class="mb-4">
                <button id="refresh-charts" class="btn-primary py-2 px-4 rounded-lg">Refresh Grafik</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <canvas id="activityChart"></canvas>
                </div>
                <div>
                    <canvas id="bidanChart"></canvas>
                </div>
            </div>
            <div class="mt-6">
                <canvas id="timeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- PENTING: GANTI URL DI BAWAH INI ---
        const google_sheet_url = 'https://script.google.com/macros/s/AKfycbySZf9zvXCJD0-KcU5-0r2FOivO7kI5asl8wZ0UCEYTqk52kqjaZcaSYJBlxDFfy41d/exec';
        // --- BATAS PENGGANTIAN URL ---

        // Elemen audio tersembunyi
        // Mengatasi kebijakan autoplay browser
        document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('backgroundAudio');
            
            // Coba putar audio
            const playAudio = () => {
                audio.play().catch(error => {
                    console.log('Autoplay diblokir, menunggu interaksi pengguna');
                });
            };
            
            // Coba putar saat halaman dimuat
            playAudio();
            
            // Coba putar kembali setelah interaksi pengguna
            document.addEventListener('click', function() {
                if (audio.paused) {
                    playAudio();
                }
            });
        });
        
        // Elemen UI
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainApp = document.getElementById('main-app');
        const startButton = document.getElementById('start-button');
        const nameInput = document.getElementById('name-input');
        const formTitle = document.getElementById('form-title');
        const activityForm = document.getElementById('activity-form');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const responseMessage = document.getElementById('response-message');
        const patientNameInput = document.getElementById('patient-name');
        const activityTypeSelect = document.getElementById('activity-type');
        const activityDateInput = document.getElementById('activity-date');
        const activityTimeInput = document.getElementById('activity-time');
        const activityDayInput = document.getElementById('activity-day');
        const homecareLocationField = document.getElementById('homecare-location-field');
        const homecareLocationInput = document.getElementById('homecare-location');
        const additionalNotesInput = document.getElementById('additional-notes');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginButton = document.getElementById('login-button');
        const adminLogin = document.getElementById('admin-login');
        const adminContent = document.getElementById('admin-content');
        const adminTableBody = document.getElementById('admin-table-body');
        const refreshDataButton = document.getElementById('refresh-data');
        const refreshChartsButton = document.getElementById('refresh-charts');
        const printPdfButton = document.getElementById('print-pdf');
        const exportExcelButton = document.getElementById('export-excel');
        const printTableButton = document.getElementById('print-table');
        const filterBidanSelect = document.getElementById('filter-bidan');
        const filterKegiatanSelect = document.getElementById('filter-kegiatan');
        const filterTanggalInput = document.getElementById('filter-tanggal');

        // Data aplikasi
        let bidanName = '';
        let activitiesData = [];
        let filteredData = [];
        let activityChart, bidanChart, timeChart;

        // Inisialisasi tanggal dan waktu
        const now = new Date();
        activityDateInput.valueAsDate = now;
        activityTimeInput.value = now.toTimeString().slice(0, 5);
        updateDayFromDate();

        // Event Listeners
        startButton.addEventListener('click', () => {
            bidanName = nameInput.value.trim();
            if (bidanName) {
                welcomeScreen.classList.add('hidden');
                formTitle.textContent = `Halo, ${bidanName}! ‚ú® Ada kegiatan apa?`;
                mainApp.classList.remove('hidden');
                loadActivitiesData();
            } else {
                alert('Nama tidak boleh kosong ya!');
            }
        });

        // Toggle field lokasi home care berdasarkan jenis kegiatan
        activityTypeSelect.addEventListener('change', function() {
            if (this.value === 'Home Care') {
                homecareLocationField.style.display = 'block';
            } else {
                homecareLocationField.style.display = 'none';
                homecareLocationInput.value = '';
            }
        });

        activityDateInput.addEventListener('change', updateDayFromDate);
        activityTimeInput.addEventListener('change', updateDayFromDate);

        refreshDataButton?.addEventListener('click', loadActivitiesData);
        refreshChartsButton?.addEventListener('click', updateCharts);
        
        // Event listeners untuk fitur cetak/export
        printPdfButton?.addEventListener('click', printToPdf);
        exportExcelButton?.addEventListener('click', exportToExcel);
        printTableButton?.addEventListener('click', printTable);
        
        // Event listeners untuk filter
        filterBidanSelect?.addEventListener('change', applyFilters);
        filterKegiatanSelect?.addEventListener('change', applyFilters);
        filterTanggalInput?.addEventListener('change', applyFilters);

        activityForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (google_sheet_url === 'GANTI_DENGAN_URL_GOOGLE_APPS_SCRIPT_ANDA') {
                responseMessage.textContent = '‚õî URL Google Sheet belum diatur!';
                responseMessage.className = 'text-center mt-4 font-bold text-red-600';
                return;
            }

            // Show loading and disable button
            loadingSpinner.classList.remove('hidden');
            responseMessage.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'Mengirim...';

            const activityDate = new Date(activityDateInput.value);
            const day = activityDayInput.value;
            
            // Format tanggal sesuai dengan format di sheet (YYYY-MM-DD)
            const date = activityDate.toISOString().split('T')[0];
            
            // Format waktu sesuai dengan format di sheet (HH:MM:SS)
            const time = activityTimeInput.value + ':00';

            const activityType = activityTypeSelect.value;
            const patientName = patientNameInput.value.trim();
            const homecareLocation = activityType === 'Home Care' ? homecareLocationInput.value.trim() : '';
            const additionalNotes = additionalNotesInput.value.trim();

            const formData = {
                namaBidan: bidanName,
                kegiatan: activityType,
                namaPasien: patientName,
                hari: day,
                tanggal: date, // Format: YYYY-MM-DD
                jam: time,     // Format: HH:MM:SS
                lokasiHomeCare: homecareLocation,
                keterangan: additionalNotes
            };

            fetch(google_sheet_url, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(() => {
                responseMessage.textContent = 'Data berhasil terkirim! üéâ';
                responseMessage.className = 'text-center mt-4 font-bold text-green-600';
                activityForm.reset();
                
                // Reset tanggal dan waktu ke saat ini
                const now = new Date();
                activityDateInput.valueAsDate = now;
                activityTimeInput.value = now.toTimeString().slice(0, 5);
                updateDayFromDate();
                
                // Reset field opsional
                homecareLocationField.style.display = 'none';
                homecareLocationInput.value = '';
                additionalNotesInput.value = '';
                
                // Refresh data
                loadActivitiesData();
            })
            .catch(error => {
                console.error('Error:', error);
                responseMessage.textContent = 'Oops! Gagal mengirim data. Coba lagi.';
                responseMessage.className = 'text-center mt-4 font-bold text-red-600';
            })
            .finally(() => {
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Kirim Laporan';
                setTimeout(() => { responseMessage.textContent = ''; }, 4000);
            });
        });

        // Fungsi untuk mengupdate hari berdasarkan tanggal
        function updateDayFromDate() {
            const date = new Date(activityDateInput.value);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            activityDayInput.value = days[date.getDay()];
        }

        // Fungsi untuk beralih tab
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Nonaktifkan semua tab
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Aktifkan tab yang dipilih
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Jika tab statistik dipilih, perbarui grafik
                if (tabId === 'stats-tab') {
                    updateCharts();
                }
                // Jika tab admin dipilih, muat data
                else if (tabId === 'admin-tab') {
                    loadActivitiesData();
                }
            });
        });

        // Fungsi untuk login admin
        loginButton.addEventListener('click', () => {
            const password = adminPasswordInput.value.trim();
            if (password === '112211') {
                adminLogin.classList.add('hidden');
                adminContent.classList.remove('hidden');
                loadAdminData();
            } else {
                alert('Sandi salah!');
            }
        });

        // Fungsi untuk memuat data kegiatan dari Google Sheets
        function loadActivitiesData() {
            // Mengambil data dari Google Sheets menggunakan GET
            fetch(google_sheet_url + '?action=getData')
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        activitiesData = data.data;
                        filteredData = [...activitiesData];
                        updateFilterOptions();
                        if (adminContent.classList.contains('hidden') === false) {
                            loadAdminData();
                        }
                    } else {
                        console.error('Error loading data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // Fallback ke data simulasi jika gagal
                    activitiesData = getSimulatedData();
                    filteredData = [...activitiesData];
                    updateFilterOptions();
                    if (adminContent.classList.contains('hidden') === false) {
                        loadAdminData();
                    }
                });
        }

        // Data simulasi (fallback)
        function getSimulatedData() {
            return [
                { 
                    hari: 'Kamis', 
                    tanggal: '2025-09-25', 
                    jam: '16:30:00', 
                    namaBidan: 'Linda Warnii', 
                    kegiatan: 'Lembur', 
                    namaPasien: 'Yuli Ridata Hasibuan',
                    lokasiHomeCare: '',
                    keterangan: 'Lembur malam'
                },
                { 
                    hari: 'Minggu', 
                    tanggal: '2025-09-07', 
                    jam: '09:39:00', 
                    namaBidan: 'aisyah', 
                    kegiatan: 'Home Care', 
                    namaPasien: 'beryl',
                    lokasiHomeCare: 'Rumah Pasien - Jl. Merdeka No. 123',
                    keterangan: 'Kontrol rutin'
                }
            ];
        }

        // Update opsi filter
        function updateFilterOptions() {
            // Update filter bidan
            const bidanList = [...new Set(activitiesData.map(item => item.namaBidan))];
            filterBidanSelect.innerHTML = '<option value="all">Semua Bidan</option>';
            bidanList.forEach(bidan => {
                filterBidanSelect.innerHTML += `<option value="${bidan}">${bidan}</option>`;
            });

            // Update filter kegiatan
            const kegiatanList = [...new Set(activitiesData.map(item => item.kegiatan))];
            filterKegiatanSelect.innerHTML = '<option value="all">Semua Kegiatan</option>';
            kegiatanList.forEach(kegiatan => {
                filterKegiatanSelect.innerHTML += `<option value="${kegiatan}">${kegiatan}</option>`;
            });
        }

        // Terapkan filter
        function applyFilters() {
            const selectedBidan = filterBidanSelect.value;
            const selectedKegiatan = filterKegiatanSelect.value;
            const selectedTanggal = filterTanggalInput.value;

            filteredData = activitiesData.filter(item => {
                const bidanMatch = selectedBidan === 'all' || item.namaBidan === selectedBidan;
                const kegiatanMatch = selectedKegiatan === 'all' || item.kegiatan === selectedKegiatan;
                const tanggalMatch = !selectedTanggal || item.tanggal === selectedTanggal;
                
                return bidanMatch && kegiatanMatch && tanggalMatch;
            });

            loadAdminData();
        }

        // Fungsi untuk memuat data admin
        function loadAdminData() {
            adminTableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center py-4">Tidak ada data</td>`;
                adminTableBody.appendChild(row);
                return;
            }

            filteredData.forEach((activity, index) => {
                const row = document.createElement('tr');
                const bidanClass = getBidanColorClass(activity.namaBidan);
                row.className = bidanClass;
                row.innerHTML = `
                    <td>${activity.hari}</td>
                    <td>${activity.tanggal}</td>
                    <td>${activity.jam}</td>
                    <td>${activity.namaBidan}</td>
                    <td>${activity.kegiatan}</td>
                    <td>${activity.namaPasien}</td>
                    <td>${activity.lokasiHomeCare || '-'}</td>
                    <td>${activity.keterangan || '-'}</td>
                    <td>
                        <button class="edit-btn bg-blue-500 text-white px-2 py-1 rounded" data-index="${index}">Edit</button>
                        <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded ml-2" data-index="${index}">Hapus</button>
                    </td>
                `;
                adminTableBody.appendChild(row);
            });

            // Tambahkan event listener untuk tombol edit dan hapus
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    editActivity(index);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-index');
                    deleteActivity(index);
                });
            });
        }

        // Fungsi untuk mendapatkan kelas warna berdasarkan nama bidan
        function getBidanColorClass(namaBidan) {
            const bidanColors = {
                'Linda Warnii': 'bidan-linda',
                'Riska Wardana': 'bidan-riska',
                'aisyah': 'bidan-aisyah',
                'Desva': 'bidan-desva',
                'Sarina pospos': 'bidan-sarina'
            };
            return bidanColors[namaBidan] || 'bidan-other';
        }

        // Fungsi untuk mengedit kegiatan
        function editActivity(index) {
            const activity = filteredData[index];
            const newDate = prompt('Masukkan tanggal baru (format: YYYY-MM-DD):', activity.tanggal);
            const newTime = prompt('Masukkan waktu baru (format: HH:MM:SS):', activity.jam);
            
            if (newDate && newTime) {
                // Simulasi update data - dalam implementasi nyata, ini akan mengirim ke server
                filteredData[index].tanggal = newDate;
                filteredData[index].jam = newTime;
                loadAdminData();
                alert('Data berhasil diperbarui!');
            }
        }

        // Fungsi untuk menghapus kegiatan
        function deleteActivity(index) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                // Simulasi penghapusan data - dalam implementasi nyata, ini akan mengirim ke server
                const activityToDelete = filteredData[index];
                activitiesData = activitiesData.filter(item => 
                    !(item.hari === activityToDelete.hari && 
                      item.tanggal === activityToDelete.tanggal && 
                      item.jam === activityToDelete.jam &&
                      item.namaBidan === activityToDelete.namaBidan)
                );
                filteredData.splice(index, 1);
                loadAdminData();
                alert('Data berhasil dihapus!');
            }
        }

        // Fungsi untuk mencetak ke PDF
        function printToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(255, 154, 180);
            doc.text('LAPORAN KEGIATAN BIDAN', 15, 20);
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Klinik Nabilah Pulungan', 15, 28);
            
            // Tanggal cetak
            const now = new Date();
            doc.text(`Dicetak pada: ${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}`, 15, 35);
            
            // Data tabel
            const headers = [['No', 'Hari', 'Tanggal', 'Jam', 'Nama Bidan', 'Jenis Kegiatan', 'Nama Pasien', 'Lokasi Home Care', 'Keterangan']];
            const data = filteredData.map((item, index) => [
                index + 1,
                item.hari,
                item.tanggal,
                item.jam,
                item.namaBidan,
                item.kegiatan,
                item.namaPasien,
                item.lokasiHomeCare || '-',
                item.keterangan || '-'
            ]);
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [255, 154, 180] },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            
            doc.save(`Laporan_Bidan_${now.toISOString().split('T')[0]}.pdf`);
        }

        // Fungsi untuk export ke Excel
        function exportToExcel() {
            const data = filteredData.map((item, index) => ({
                'No': index + 1,
                'Hari': item.hari,
                'Tanggal': item.tanggal,
                'Jam': item.jam,
                'Nama Bidan': item.namaBidan,
                'Jenis Kegiatan': item.kegiatan,
                'Nama Pasien': item.namaPasien,
                'Lokasi Home Care': item.lokasiHomeCare || '-',
                'Keterangan': item.keterangan || '-'
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan Bidan');
            
            // Style header
            const headerStyle = {
                fill: { fgColor: { rgb: "FF9AB4" } },
                font: { color: { rgb: "FFFFFF" }, bold: true }
            };
            
            const now = new Date();
            XLSX.writeFile(workbook, `Laporan_Bidan_${now.toISOString().split('T')[0]}.xlsx`);
        }

        // Fungsi untuk print tabel
        function printTable() {
            const printBody = document.getElementById('print-table-body');
            const printPeriod = document.getElementById('print-period');
            
            // Update periode laporan
            const now = new Date();
            printPeriod.textContent = `Periode: ${filteredData.length > 0 ? 
                `Data terfilter - ${filteredData.length} entri` : 
                'Semua data'} - Dicetak: ${now.toLocaleDateString('id-ID')}`;
            
            // Isi data cetakan
            printBody.innerHTML = '';
            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                const bidanClass = getBidanColorClass(item.namaBidan);
                row.className = bidanClass;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.hari}</td>
                    <td>${item.tanggal}</td>
                    <td>${item.jam}</td>
                    <td>${item.namaBidan}</td>
                    <td>${item.kegiatan}</td>
                    <td>${item.namaPasien}</td>
                    <td>${item.lokasiHomeCare || '-'}</td>
                    <td>${item.keterangan || '-'}</td>
                `;
                printBody.appendChild(row);
            });
            
            // Print
            const printContent = document.getElementById('print-area').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reload event listeners
            loadActivitiesData();
        }

        // Fungsi untuk memperbarui grafik statistik
        function updateCharts() {
            // Hancurkan grafik yang ada jika ada
            if (activityChart) activityChart.destroy();
            if (bidanChart) bidanChart.destroy();
            if (timeChart) timeChart.destroy();

            // Hitung statistik
            const activityCounts = {};
            const bidanCounts = {};
            const timeCounts = {};

            activitiesData.forEach(activity => {
                // Hitung per jenis kegiatan
                activityCounts[activity.kegiatan] = (activityCounts[activity.kegiatan] || 0) + 1;
                
                // Hitung per bidan
                bidanCounts[activity.namaBidan] = (bidanCounts[activity.namaBidan] || 0) + 1;
                
                // Hitung per jam (dibulatkan ke jam terdekat)
                const hour = activity.jam.split(':')[0] + ':00';
                timeCounts[hour] = (timeCounts[hour] || 0) + 1;
            });

            // Grafik Jenis Kegiatan
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(activityCounts),
                    datasets: [{
                        data: Object.values(activityCounts),
                        backgroundColor: [
                            '#ff9ab4', '#ffc2d1', '#ff7da1', '#ff5c8d',
                            '#ff97b7', '#ffacc5', '#ffb3c6', '#ffc8dd', '#ffddd2'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribusi Jenis Kegiatan'
                        }
                    }
                }
            });

            // Grafik Kegiatan per Bidan
            const bidanCtx = document.getElementById('bidanChart').getContext('2d');
            bidanChart = new Chart(bidanCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(bidanCounts),
                    datasets: [{
                        label: 'Jumlah Kegiatan',
                        data: Object.values(bidanCounts),
                        backgroundColor: '#ff9ab4'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Kegiatan per Bidan'
                        }
                    }
                }
            });

            // Grafik Kegiatan per Waktu
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            // Urutkan jam
            const sortedHours = Object.keys(timeCounts).sort();
            timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: sortedHours,
                    datasets: [{
                        label: 'Jumlah Kegiatan',
                        data: sortedHours.map(hour => timeCounts[hour]),
                        borderColor: '#ff9ab4',
                        backgroundColor: 'rgba(255, 154, 180, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Kegiatan per Waktu (Jam)'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
